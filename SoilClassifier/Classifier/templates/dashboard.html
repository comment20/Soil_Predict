{% extends "base.html" %}
{% load static %}

{% block content %}
<head>
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .section-title {
            width: 100%;
            text-align: center;
            margin: 40px 0 20px 0;
            font-size: 2em;
            color: #333;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initial Data
            const initialSoilLabels = {{ soil_type_labels|safe }};
            const initialSoilData = {{ soil_type_data|safe }};
            const initialCropLabels = {{ crop_type_labels|safe }};
            const initialCropData = {{ crop_type_data|safe }};

            const backgroundColors = [
                'rgba(44, 94, 63, 0.6)', 'rgba(244, 162, 97, 0.6)', 'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)', 'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(231, 233, 237, 0.6)',
                'rgba(201, 203, 207, 0.6)'
            ];
            const borderColors = backgroundColors.map(color => color.replace('0.6', '1'));

            // --- SOIL CHARTS ---
            const pieSoilChart = new Chart(document.getElementById('pieSoilChart').getContext('2d'), {
                type: 'pie',
                data: { labels: initialSoilLabels, datasets: [{ data: initialSoilData, backgroundColor: backgroundColors, borderColor: borderColors }] }
            });
            const histSoilChart = new Chart(document.getElementById('histSoilChart').getContext('2d'), {
                type: 'bar',
                data: { labels: initialSoilLabels, datasets: [{ label: 'Nombre de Prédictions', data: initialSoilData, backgroundColor: backgroundColors, borderColor: borderColors }] },
                options: { scales: { y: { beginAtZero: true } } }
            });
            const barSoilChart = new Chart(document.getElementById('barSoilChart').getContext('2d'), {
                type: 'bar',
                data: { labels: initialSoilLabels, datasets: [{ label: 'Nombre de Prédictions', data: initialSoilData, backgroundColor: backgroundColors[0], borderColor: borderColors[0] }] },
                options: { indexAxis: 'y', scales: { x: { beginAtZero: true } } }
            });

            // --- CROP CHARTS ---
            const pieCropChart = new Chart(document.getElementById('pieCropChart').getContext('2d'), {
                type: 'pie',
                data: { labels: initialCropLabels, datasets: [{ data: initialCropData, backgroundColor: backgroundColors, borderColor: borderColors }] }
            });
            const histCropChart = new Chart(document.getElementById('histCropChart').getContext('2d'), {
                type: 'bar',
                data: { labels: initialCropLabels, datasets: [{ label: 'Nombre de Prédictions', data: initialCropData, backgroundColor: backgroundColors, borderColor: borderColors }] },
                options: { scales: { y: { beginAtZero: true } } }
            });
            const barCropChart = new Chart(document.getElementById('barCropChart').getContext('2d'), {
                type: 'bar',
                data: { labels: initialCropLabels, datasets: [{ label: 'Nombre de Prédictions', data: initialCropData, backgroundColor: backgroundColors[1], borderColor: borderColors[1] }] },
                options: { indexAxis: 'y', scales: { x: { beginAtZero: true } } }
            });

            // --- UPDATE FUNCTIONS ---
            async function updateCharts(url, charts) {
                try {
                    const response = await fetch(url);
                    const newData = await response.json();
                    charts.forEach(chart => {
                        chart.data.labels = newData.labels;
                        chart.data.datasets[0].data = newData.data;
                        chart.update();
                    });
                } catch (error) {
                    console.error(`Error fetching data from ${url}:`, error);
                }
            }

            // Set intervals for updates
            setInterval(() => updateCharts('/api/dashboard-data/', [pieSoilChart, histSoilChart, barSoilChart]), 5000);
            setInterval(() => updateCharts('/api/crop-dashboard-data/', [pieCropChart, histCropChart, barCropChart]), 5500);
        });
    </script>
    <link rel="stylesheet" href="{% static 'dashboard.css' %}">
</head>

<div class="dashboard-container">
    <h1 class="section-title">Analyse des Sols</h1>
    <div class="chart-row">
        <div class="chart-container">
            <h2>Distribution (Circulaire)</h2>
            <canvas id="pieSoilChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>Distribution (Histogramme)</h2>
            <canvas id="histSoilChart"></canvas>
        </div>
    </div>
    <div class="full-width-chart-container">
        <h2>Prédictions par Type (Barres)</h2>
        <canvas id="barSoilChart"></canvas>
    </div>

    <h1 class="section-title">Analyse des Cultures</h1>
    <div class="chart-row">
        <div class="chart-container">
            <h2>Distribution (Circulaire)</h2>
            <canvas id="pieCropChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>Distribution (Histogramme)</h2>
            <canvas id="histCropChart"></canvas>
        </div>
    </div>
    <div class="full-width-chart-container">
        <h2>Prédictions par Type (Barres)</h2>
        <canvas id="barCropChart"></canvas>
    </div>
</div>

{% endblock %}